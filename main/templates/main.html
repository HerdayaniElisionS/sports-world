{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard{% endblock title %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-3xl font-semibold text-gray-900 mb-6">Product Catalog</h1>

  <!-- Filter Buttons -->
  <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
    <div class="flex items-center space-x-3">
      <a href="?filter=all">
        <button id="btnAll"
          class="bg-blue-500 text-white px-5 py-2.5 rounded-full hover:opacity-90 transition-all">
          All Products
        </button>
      </a>
      <a href="?filter=my">
        <button id="btnMy"
          class="bg-white text-gray-700 border border-gray-300 px-5 py-2.5 rounded-full hover:opacity-90 transition-all">
          My Products
        </button>
      </a>
    </div>

    <button onclick="showProductCreateModal()"
      class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-full transition-colors">
      + Add Product
    </button>
  </div>

  <!-- AJAX States -->
  <div id="loading" class="text-center py-12 bg-white rounded-2xl border border-gray-200 hidden">
    <div class="w-8 h-8 mx-auto mb-4 animate-spin border-4 border-blue-500 border-t-transparent rounded-full"></div>
    <p class="text-gray-600">Loading products...</p>
  </div>

  <div id="error" class="text-center py-12 bg-white rounded-2xl border border-gray-200 hidden">
    <h3 class="text-2xl font-semibold text-gray-900 mb-2">Failed to load</h3>
    <p class="text-gray-600">Please try again later.</p>
  </div>

  <div id="empty" class="text-center py-12 bg-white rounded-2xl border border-gray-200 hidden">
    <div class="w-48 h-48 mx-auto mb-6">
      <img src="{% static 'image/image.png' %}" alt="No products available"
        class="w-full h-full object-contain">
    </div>
    <h3 class="text-2xl font-semibold text-gray-900 mb-2">No products available</h3>
    <p class="text-gray-600 mb-6">Be the first to add a product!</p>
    <button onclick="showProductCreateModal()"
      class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2.5 rounded-full transition-colors">
      Add Product
    </button>
  </div>

  <!-- Product Grid -->
  <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>

<script>
  const LIST_URL = "{% url 'main:show_json' %}";
  const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
  const urlParams = new URLSearchParams(window.location.search);
  const activeFilter = urlParams.get('filter') === 'my' ? 'my' : 'all';

  const grid = document.getElementById('productGrid');
  const loading = document.getElementById('loading');
  const empty = document.getElementById('empty');
  const errorBox = document.getElementById('error');

  // Helper: show one state
  function showOnly(el) {
    [grid, loading, empty, errorBox].forEach(e => e.classList.add('hidden'));
    el.classList.remove('hidden');
  }

  function moneyIDR(v) {
    const n = Number(v || 0);
    return 'Rp ' + n.toLocaleString('id-ID');
  }

  function badgeForCategory(cat) {
    if (cat === 'shoes')
      return `<span class="text-xs font-medium text-orange-800 bg-orange-100 px-3 py-1 rounded-full uppercase">${cat}</span>`;
    if (cat === 'jersey')
      return `<span class="text-xs font-medium text-purple-800 bg-purple-100 px-3 py-1 rounded-full uppercase">${cat}</span>`;
    if (cat === 'equipment')
      return `<span class="text-xs font-medium text-amber-800 bg-amber-100 px-3 py-1 rounded-full uppercase">${cat}</span>`;
    return `<span class="text-xs font-medium text-gray-600 uppercase">${cat || ''}</span>`;
  }

  // Build one card
  function renderCard(obj) {
    const f = obj.fields || {};
    const id = obj.pk;
    const name = DOMPurify.sanitize(f.name || '');
    const desc = DOMPurify.sanitize(f.description || '');
    const category = DOMPurify.sanitize(f.category || '');
    const price = f.price;
    const thumb = f.thumbnail || f.image_url || '';

    const wrapper = document.createElement('div');
    wrapper.className = "bg-white rounded-2xl border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow";

    wrapper.innerHTML = `
      <div class="h-48 bg-gray-100 flex items-center justify-center overflow-hidden">
        ${thumb ? `<img src="${thumb}" alt="${name}" class="w-full h-full object-cover">`
                : `<svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                           d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                   </svg>`}
      </div>

      <div class="p-4">
        <div class="flex items-center justify-between mb-2">
          ${badgeForCategory(category)}
          ${f.is_featured ? `<span class="bg-yellow-100 text-yellow-800 text-xs px-3 py-1 rounded-full">Featured</span>` : ``}
        </div>

        <h3 class="text-lg font-semibold text-gray-900 mb-2">${name}</h3>
        <p class="text-gray-600 text-sm mb-3 line-clamp-2">${desc}</p>

        <div class="flex items-center justify-between mb-3">
          <span class="text-2xl font-bold text-gray-900">${moneyIDR(price)}</span>
        </div>

        <div class="flex gap-2">
          <a href="/products/${id}/" class="flex-1">
            <button class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
              View Details
            </button>
          </a>

          ${String(f.user) === String(CURRENT_USER_ID)
            ? `<a href="/products/${id}/edit/">
                 <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">Edit</button>
               </a>
               <a href="/products/${id}/delete/">
                 <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">Delete</button>
               </a>`
            : ``}
        </div>

        ${f.user_display ? `<p class="text-xs text-gray-500 mt-3">Seller: ${DOMPurify.sanitize(f.user_display)}</p>` : ``}
      </div>
    `;
    return wrapper;
  }

  async function loadProducts() {
    try {
      showOnly(loading);
      const res = await fetch(LIST_URL, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('fetch_failed');
      const raw = await res.json();
      const data = (activeFilter === 'my')
        ? raw.filter(x => String(x.fields?.user) === String(CURRENT_USER_ID))
        : raw;

      if (!data.length) {
        showOnly(empty);
        grid.innerHTML = '';
        return;
      }

      grid.innerHTML = '';
      data.forEach(obj => grid.appendChild(renderCard(obj)));
      showOnly(grid);
    } catch (e) {
      console.error(e);
      showOnly(errorBox);
    }
  }

  document.addEventListener('DOMContentLoaded', loadProducts);
  document.addEventListener('productChanged', loadProducts);
</script>
{% endblock content %}
