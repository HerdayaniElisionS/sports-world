<!-- Product Modal -->
<div id="productModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="productModalContent" class="bg-white rounded-lg shadow-lg w-11/12 sm:w-2/3 md:w-1/2 max-h-screen overflow-y-auto">
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h3 id="pm-title" class="text-xl font-semibold text-gray-900">Create Product</h3>
        <p id="pm-subtitle" class="text-sm text-gray-600 mt-1">Manage your products via AJAX</p>
      </div>
      <button type="button" class="text-gray-400 hover:text-gray-900 p-1.5" onclick="hideProductModal()">âœ•</button>
    </div>

    <div class="px-6 py-4">
      <form id="productForm">
        <input type="hidden" id="pm-product-id" name="id" />
        <div class="mb-4">
          <label for="pm-name" class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" id="pm-name" name="name" class="mt-1 w-full border border-gray-300 rounded px-3 py-2" required>
        </div>
        <div class="mb-4">
          <label for="pm-description" class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="pm-description" name="description" rows="3" class="mt-1 w-full border border-gray-300 rounded px-3 py-2" required></textarea>
        </div>
        <div class="mb-4">
          <label for="pm-price" class="block text-sm font-medium text-gray-700">Price</label>
          <input type="number" step="0.01" id="pm-price" name="price" class="mt-1 w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div class="mb-4">
          <label for="pm-stock" class="block text-sm font-medium text-gray-700">Stock</label>
          <input type="number" id="pm-stock" name="stock" class="mt-1 w-full border border-gray-300 rounded px-3 py-2">
        </div>
        <div class="mb-4">
          <label for="pm-image" class="block text-sm font-medium text-gray-700">Image URL</label>
          <input type="url" id="pm-image" name="image_url" class="mt-1 w-full border border-gray-300 rounded px-3 py-2" placeholder="https://example.com/image.jpg">
        </div>
      </form>
    </div>

    <div class="flex gap-3 p-6 border-t">
      <button type="button" class="px-6 py-3 border border-gray-300 rounded" onclick="hideProductModal()">Cancel</button>
      <button type="submit" form="productForm" class="flex-1 bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700">Save</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="deleteModalContent" class="bg-white rounded-lg shadow-lg w-11/12 sm:w-96 max-h-screen">
    <div class="p-5 border-b">
      <h3 class="text-lg font-semibold text-gray-900">Delete Product</h3>
      <p class="text-sm text-gray-600 mt-1">Are you sure you want to delete this product? This action cannot be undone.</p>
    </div>
    <div class="p-5">
      <input type="hidden" id="delete-product-id">
      <div id="deleteProductName" class="text-gray-800 font-medium"></div>
    </div>
    <div class="flex gap-3 p-5 border-t">
      <button type="button" class="px-6 py-3 border border-gray-300 rounded" onclick="hideDeleteProductModal()">Cancel</button>
      <button type="button" class="flex-1 bg-red-600 text-white px-6 py-3 rounded hover:bg-red-700" onclick="confirmDeleteProduct()">Delete</button>
    </div>
  </div>
</div>

<script>
function showProductCreateModal(){
  document.getElementById('pm-title').textContent = 'Create Product';
  document.getElementById('pm-product-id').value = '';
  document.getElementById('productForm').reset();
  showProductModal();
}

function showProductEditModal(id){
  document.getElementById('pm-title').textContent = 'Edit Product';
  document.getElementById('pm-product-id').value = id;

  const url = "{% url 'main:product_detail_json' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', id);
  fetch(url, { headers:{'Accept':'application/json'} })
    .then(r=> r.ok ? r.json() : Promise.reject())
    .then(p=>{
      document.getElementById('pm-name').value = p.name || '';
      document.getElementById('pm-description').value = p.description || '';
      if (p.price!=null) document.getElementById('pm-price').value = p.price;
      if (p.stock!=null) document.getElementById('pm-stock').value = p.stock;
      document.getElementById('pm-image').value = p.image_url || p.thumbnail || '';
    })
    .catch(() => showToast('Failed to load product', 'error'));

  showProductModal();
}

function showProductModal(){
  const m = document.getElementById('productModal');
  const c = document.getElementById('productModalContent');
  m.classList.remove('hidden');
  setTimeout(()=>{ c.classList.add('opacity-100','scale-100'); c.classList.remove('opacity-0','scale-95'); }, 50);
}
function hideProductModal(){
  const m = document.getElementById('productModal');
  const c = document.getElementById('productModalContent');
  c.classList.remove('opacity-100','scale-100'); c.classList.add('opacity-0','scale-95');
  setTimeout(()=> m.classList.add('hidden'), 150);
}

document.getElementById('productForm').addEventListener('submit', async function(e){
  e.preventDefault();

  const id = document.getElementById('pm-product-id').value;
  const formData = new FormData(this);

  const createUrl = "{% url 'main:add_product_entry_ajax' %}";
  const updateTpl = "{% url 'main:update_product_entry_ajax' '00000000-0000-0000-0000-000000000000' %}";
  const url = id ? updateTpl.replace('00000000-0000-0000-0000-000000000000', id) : createUrl;

  try {
    const res = await fetch(url, { method: "POST", body: formData });
    if (!res.ok) throw new Error('save_failed');

    this.reset();
    hideProductModal();
    showToast(id ? 'Product updated successfully' : 'Product created successfully', 'success');
    document.dispatchEvent(new CustomEvent('productChanged'));
  } catch {
    showToast('Failed to save product', 'error');
  }
});

// ------- Delete Confirmation Modal -------
const DELETE_URL_TPL = "{% url 'main:delete_product_entry_ajax' '00000000-0000-0000-0000-000000000000' %}";
const DETAIL_URL_TPL = "{% url 'main:product_detail_json' '00000000-0000-0000-0000-000000000000' %}";

function openDeleteProductModal(id) {
  document.getElementById('delete-product-id').value = id;
  const detailUrl = DETAIL_URL_TPL.replace('00000000-0000-0000-0000-000000000000', id);

  fetch(detailUrl, { headers: { 'Accept': 'application/json' } })
    .then(r => r.ok ? r.json() : null)
    .then(p => {
      const name = p && p.name ? DOMPurify.sanitize(p.name) : '';
      document.getElementById('deleteProductName').textContent = name ? `Product: ${name}` : '';
    })
    .catch(() => { /* silent */ });

  showDeleteProductModal();
}

function showDeleteProductModal() {
  const m = document.getElementById('deleteModal');
  const c = document.getElementById('deleteModalContent');
  m.classList.remove('hidden');
  setTimeout(() => {
    c.classList.add('opacity-100','scale-100');
    c.classList.remove('opacity-0','scale-95');
  }, 50);
}

function hideDeleteProductModal() {
  const m = document.getElementById('deleteModal');
  const c = document.getElementById('deleteModalContent');
  c.classList.remove('opacity-100','scale-100');
  c.classList.add('opacity-0','scale-95');
  setTimeout(() => m.classList.add('hidden'), 150);
}

async function confirmDeleteProduct() {
  const id = document.getElementById('delete-product-id').value;
  if (!id) return;

  const url = DELETE_URL_TPL.replace('00000000-0000-0000-0000-000000000000', id);
  try {
    const res = await fetch(url, { method: 'POST' });
    if (!res.ok) throw new Error('delete_failed');

    showToast('Product deleted successfully', 'success');
    hideDeleteProductModal();
    document.dispatchEvent(new CustomEvent('productChanged'));
  } catch {
    showToast('Failed to delete product', 'error');
  }
}

// helpers for other pages
window.showProductCreateModal = showProductCreateModal;
window.showProductEditModal = showProductEditModal;
window.openDeleteProductModal = openDeleteProductModal;
</script>
