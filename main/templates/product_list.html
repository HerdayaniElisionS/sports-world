{% extends 'base.html' %}
{% load static %}

{% block title %}Products{% endblock title %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl md:text-3xl font-semibold text-gray-900">Products</h1>

    <div class="flex gap-3">
      <button
        id="refresh-products-btn"
        onclick="refreshProducts()"
        class="inline-flex items-center px-3 py-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-50 transition"
        title="Refresh products"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v6h6M20 20v-6h-6M5 19A9 9 0 1019 5l-2.5 2.5"/>
        </svg>
      Refresh
      </button>

      <!-- Create button (opens your existing modal) -->
      <button
        onclick="showProductCreateModal()"
        class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-full hover:bg-green-700 transition"
      >
        Create Product (AJAX)
      </button>
    </div>
  </div>

  <!-- Loading / Error / Empty states -->
  <div id="p-loading" class="bg-white rounded-2xl border border-gray-200 p-10 text-center hidden">
    <p class="text-gray-600">Loading products…</p>
  </div>

  <div id="p-error" class="bg-white rounded-2xl border border-gray-200 p-10 text-center hidden">
    <p class="text-red-600">Failed to load products. Please try again.</p>
  </div>

  <div id="p-empty" class="bg-white rounded-2xl border border-gray-200 p-10 text-center hidden">
    <p class="text-gray-600">No products found.</p>
  </div>

  <div id="product-grid" class="hidden"></div>
</div>

<script>
const LIST_URL = "{% url 'main:product_list_json' %}";
const DETAIL_PAGE_TPL = "{% url 'main:product_detail' '00000000-0000-0000-0000-000000000000' %}";

const loadingEl = document.getElementById('p-loading');
const errorEl   = document.getElementById('p-error');
const emptyEl   = document.getElementById('p-empty');
const gridEl    = document.getElementById('product-grid');

function setState({loading=false, error=false, empty=false, grid=false}) {
  loadingEl.classList.toggle('hidden', !loading);
  errorEl.classList.toggle('hidden', !error);
  emptyEl.classList.toggle('hidden', !empty);
  gridEl.classList.toggle('hidden', !grid);

  if (grid) {
    gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';
  }
}

function rupiah(n){
  if(n == null) return '';
  try { return new Intl.NumberFormat('id-ID').format(n); } catch { return n; }
}

function productCard(p) {
  const id    = p.id;
  const name  = DOMPurify.sanitize(p.name || '');
  const desc  = DOMPurify.sanitize(p.description || '');
  const price = p.price != null ? `Rp.${rupiah(p.price)}` : '';
  const stock = p.stock != null ? p.stock : '';
  const img   = DOMPurify.sanitize(p.image_url || p.thumbnail || '');
  const dateStr = p.created_at ? new Date(p.created_at)
                      .toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'}) : '';

  const detailUrl = DOMPurify.sanitize(DETAIL_PAGE_TPL.replace('00000000-0000-0000-0000-000000000000', id));

  const imgHtml = img
    ? `<img src="${img}" alt="${name}" class="w-full h-full object-cover">`
    : `<div class="w-full h-full bg-gray-100 flex items-center justify-center">
         <svg class="w-14 h-14 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
         </svg>
       </div>`;

  return `
  <article class="bg-white rounded-2xl border border-gray-200 hover:shadow-sm transition overflow-hidden flex flex-col h-full">
    <div class="aspect-[16/9] relative overflow-hidden">${imgHtml}</div>
    <div class="p-5 flex flex-col flex-1">
      <div class="flex items-center text-sm text-gray-500 mb-2">
        <time>${dateStr}</time>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">
        <a class="hover:text-green-600" href="${detailUrl}">${name}</a>
      </h3>
      <p class="text-gray-600 text-sm line-clamp-3 mb-3">${desc}</p>
      <div class="text-sm text-gray-700 mb-4">
        ${price ? `Price: ${price}` : ''} ${price && stock !== '' ? ' • ' : ''} ${stock !== '' ? `Stock: ${stock}` : ''}
      </div>
      <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
        <a href="${detailUrl}" class="text-green-600 hover:text-green-700 font-medium text-sm">View</a>
        <div class="flex gap-3">
          <button onclick="showProductEditModal('${id}')" class="text-gray-600 hover:text-gray-700 text-sm">Edit</button>
          <button onclick="openDeleteProductModal('${id}')" class="text-red-600 hover:text-red-700 text-sm">Delete</button>
        </div>
      </div>
    </div>
  </article>`;
}

async function loadProducts() {
  try {
    setState({loading:true});

    const res = await fetch(LIST_URL, { headers: {'Accept':'application/json'} });
    if (!res.ok) throw new Error('fetch_failed');

    const data = await res.json();

    if (!data || data.length === 0) {
      setState({empty:true});
      return;
    }

    gridEl.innerHTML = '';
    data.forEach(p => {
      const wrap = document.createElement('div');
      wrap.innerHTML = productCard(p);
      gridEl.appendChild(wrap.firstElementChild);
    });

    setState({grid:true});
  } catch (e) {
    setState({error:true});
  }
}

function refreshProducts() {
  loadProducts();
}

document.addEventListener('productChanged', loadProducts);

// Initial load
loadProducts();
</script>
{% endblock content %}
